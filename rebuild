#!/usr/bin/env bash

git add .

printf "Workstation (y/n)? "
read machine_type
printf $machine_type

# -Q --no-build-output is broken
nh os switch --hostname $machine_type
# sudo nixos-rebuild switch --flake ./hosts/$machine_type#$machine_type --install-bootloader 

notify-send "NixOS finished rebuilding!"

if [[ $machine_type = "laptop" ]]; then
    currentDate=$(date +"LAP: %Y-%m-%d %H:%M:%S")
else
    currentDate=$(date +"WRK: %Y-%m-%d %H:%M:%S")
fi

sudo chown -R udontur:777 ./.git
git add .
git commit -m "$currentDate" &> git-commit.log

read -p "Back it up? " user_input

printf "\033[A\033[K\033[A\033[K"

if [[ $user_input =~ ^[Yy]$ ]]; then
    git push origin HEAD &> git-sync.log || (git push origin main && exit 1)
    if [ $? -ne 0 ]; then
        printf "\033[A\033[KError: Failed to back up :c\n"
        exit 1
    else
        printf "\033[A\033[KEnjoy your system! :D\n"
    fi
else
    printf "NOT backed up :c\n"

